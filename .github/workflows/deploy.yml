name: CI/CD with Docker Compose (Full Sync + Fix Permissions)

on:
  push:
    branches:
      - develop
      - deploy
  pull_request:
    branches: [develop]
  workflow_dispatch:

jobs:
  deploy:
    if: github.event_name == 'push'
    runs-on: ubuntu-latest
    environment:
      name: ${{ github.ref_name }}

    steps:
      # 코드 체크아웃
      - name: Checkout repository
        uses: actions/checkout@v3

      # EC2 권한 복구 (rsync 전에 실행)
      - name: Fix permissions on EC2 before sync
        uses: appleboy/ssh-action@v1.2.0
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USER }}
          key: ${{ secrets.EC2_PEM_KEY }}
          script: |
            echo "===== Fixing permissions before rsync ====="
            sudo mkdir -p /home/ubuntu/Team15_BE
            sudo chown -R ubuntu:ubuntu /home/ubuntu/Team15_BE

      # EC2로 코드 완전 동기화 (깃 기준으로 삭제/덮어쓰기)
      - name: Sync source files to EC2 (full mirror)
        uses: burnett01/rsync-deployments@5.2.1
        with:
          switches: -avzr --checksum --delete --delete-excluded --force --ignore-errors --ignore-missing-args --no-perms --chmod=ugo=rwX \
            --exclude='.git/' \
            --exclude='.idea/' \
            --exclude='.gradle/' \
            --exclude='build/' \
            --exclude='tmp/' \
            --exclude='src/test/**' \
            --exclude='**/__pycache__/**' \
            --exclude='*.log' \
            --exclude='*~' \
            --exclude='.DS_Store' \
            --exclude='.env' \
            --exclude='docker-compose.yml'
          path: ./
          remote_path: /home/ubuntu/Team15_BE
          remote_host: ${{ secrets.EC2_HOST }}
          remote_user: ${{ secrets.EC2_USER }}
          remote_key: ${{ secrets.EC2_PEM_KEY }}
        continue-on-error: true

      # EC2에서 Docker 빌드 및 재시작
      - name: Run Docker Compose on EC2 (full rebuild)
        uses: appleboy/ssh-action@v1.2.0
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USER }}
          key: ${{ secrets.EC2_PEM_KEY }}
          script: |
            echo "===== Set ownership for project ====="
            sudo chown -R ubuntu:ubuntu /home/ubuntu/Team15_BE
            cd /home/ubuntu/Team15_BE

            echo "===== Generate .env ====="
            cat > .env <<EOF
            SPRING_PROFILES_ACTIVE=${{ secrets.SPRING_PROFILES_ACTIVE }}
            DB_HOST=${{ secrets.DB_HOST }}
            DB_PORT=${{ secrets.DB_PORT }}
            DB_NAME=${{ secrets.DB_NAME }}
            DB_USER=${{ secrets.DB_USER }}
            DB_PASSWORD=${{ secrets.DB_PASSWORD }}
            DB_ROOT_PASSWORD=${{ secrets.DB_ROOT_PASSWORD }}
            REDIS_HOST=${{ secrets.REDIS_HOST }}
            REDIS_PORT=${{ secrets.REDIS_PORT }}
            JWT_SECRET=${{ secrets.JWT_SECRET }}
            OPENAI_API_KEY=${{ secrets.OPENAI_API_KEY }}
            KAKAO_CLIENT_ID=${{ secrets.KAKAO_CLIENT_ID }}
            KAKAO_REDIRECT_URI=${{ secrets.KAKAO_REDIRECT_URI }}
            GOOGLE_CLIENT_ID=${{ secrets.GOOGLE_CLIENT_ID }}
            GOOGLE_CLIENT_SECRET=${{ secrets.GOOGLE_CLIENT_SECRET }}
            GOOGLE_REDIRECT_URI=${{ secrets.GOOGLE_REDIRECT_URI }}
            MAIL_USERNAME=${{ secrets.MAIL_USERNAME }}
            MAIL_PASSWORD=${{ secrets.MAIL_PASSWORD }}
            FRONTEND_URLS=${{ secrets.FRONTEND_URLS }}
            APP_PORT=${{ secrets.APP_PORT }}
            GF_SECURITY_ADMIN_USER=${{ secrets.GF_SECURITY_ADMIN_USER }}
            GF_SECURITY_ADMIN_PASSWORD=${{ secrets.GF_SECURITY_ADMIN_PASSWORD }}
            EOF

            echo ".env file created at /home/ubuntu/Team15_BE/.env"
            ls -al .env

            echo "===== Build Application Containers (no cache) ====="
            docker compose build --no-cache app || (echo "Build failed" && exit 1)

            echo "===== Restart Application (force recreate) ====="
            docker compose down app || true
            docker compose up -d --force-recreate --build app redis || (echo "Compose up failed" && exit 1)

            echo "===== Container Status ====="
            docker compose ps

            echo "===== Last 100 Lines of App Logs ====="
            docker logs --tail=100 hyuswim-app
